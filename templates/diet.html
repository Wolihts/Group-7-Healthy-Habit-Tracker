{% extends "base.html" %}
{% block title %}Diet Page{% endblock %}
{% block header %}Diet Tracker{% endblock %}

{% block body %}
  <div class="bx">
    <form action="/diet" method="post">
      <label for="date">Date:</label>
      <input type="date" name="date" id="date" required>
      <label for="mealname">What did you eat?</label>
      <input type="text" id="mealname" name="mealname" required>
      <label for="rating">Rate the overall healthiness (1–10):</label>
      <input type="number" name="rating" id="rating" min="1" max="10" step="1">
      <label for="notes">Additional notes:</label>
      <input type="text" name="notes" id="notes" placeholder="Optional notes">
      <input type="submit" value="Submit">
    </form>
  </div>

  <div class="bx">
      {% for tip in tips %}
  <p>{{tip}}</p>
  {% endfor %}
  </div>
  <!-- Chart Section -->
  <div class="chart-container" style="margin: 2rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
    <h3 class="ctr">Diet Health Rating Trends</h3>
    <canvas id="dietChart" width="400" height="200"></canvas>
  </div>

  <h2 class="ctr">Recent Diet Logs</h2>
  <div class="cards">
    {% for entry in diet_data %}
      {# indices: 0:id, 1:name, 2:date, 3:notes, 4:rating #}
      {% set rating = entry[4] or 0 %}
      {% set badge = 'r-g' if rating|int >= 8 else ('r-o' if rating|int >= 5 else 'r-r') %}
      <article class="card">
        <div class="card-hd">
          <span class="dt">{{ entry[2] }}</span>
          <span class="pill r-b {{ badge }}">Rating: {{ rating }}</span>
        </div>
        <div class="grid">
          <div class="kpi">
            <div class="k-l">Meal</div>
            <div class="k-v">{{ entry[1] }}</div>
          </div>
          <div class="kpi">
            <div class="k-l">Health (1–10)</div>
            <div class="k-v">{{ rating or '–' }}</div>
          </div>
        </div>
        <div class="nts">
          <details>
            <summary>Notes</summary>
            <p>{{ entry[3] or 'No notes' }}</p>
          </details>
        </div>
      </article>
    {% endfor %}
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // Prepare data for Chart.js
    const dietData = JSON.parse('{{ diet_chart_data | tojson | safe }}');
    
    const labels = dietData.map(entry => entry[0]); // dates
    const ratings = dietData.map(entry => parseInt(entry[1]) || 0); // diet ratings
    
    const ctx = document.getElementById('dietChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Health Rating (1-10)',
          data: ratings,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#f59e0b',
          pointBorderColor: '#d97706',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 10,
            title: {
              display: true,
              text: 'Health Rating'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Date'
            }
          }
        }
      }
    });
  </script>
{% endblock %}
